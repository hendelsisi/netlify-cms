<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>CMS</title>
  <style>
    #cms-root {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 2147483647;
      background: white;
    }
  </style>
</head>
<body>
  <!-- Stable mount point -->
  <div id="cms-root"></div>
  <script>
    (function() {
      // 1. Ensure DOM is completely ready
      function domReady(fn) {
        if (document.readyState === 'complete') {
          setTimeout(fn, 100);
        } else {
          window.addEventListener('load', function() {
            setTimeout(fn, 100);
          });
        }
      }

      // 2. Bulletproof initialization
      function initCMS() {
        // Create guaranteed mount point
        let root = document.getElementById('cms-root');
        if (!root) {
          root = document.createElement('div');
          root.id = 'cms-root';
          document.body.appendChild(root);
        }
        root.innerHTML = '';

        // Load script with fallback
        const loadScript = (src, onSuccess, onError, attempts = 0) => {
          const script = document.createElement('script');
          script.src = src;
          script.onload = onSuccess;
          script.onerror = function() {
            if (attempts < 2) {
              setTimeout(() => loadScript(src, onSuccess, onError, attempts + 1), 500);
            } else {
              onError();
            }
          };
          document.body.appendChild(script);
        };

        loadScript(
          'https://unpkg.com/decap-cms@3.7.1/dist/decap-cms.js',
          function() {
            if (window.CMS) {
              try {
                // Extra DOM readiness check
                requestAnimationFrame(() => {
                  const checkRoot = document.getElementById('cms-root');
                  if (checkRoot) {
                    window.CMS.init();
                    console.log('CMS initialized successfully');
                  } else {
                    console.error('Mount point disappeared');
                    initCMS(); // Retry
                  }
                });
              } catch (e) {
                console.error('CMS init error:', e);
                setTimeout(initCMS, 1000);
              }
            }
          },
          function() {
            console.error('Failed to load CMS script');
            // Fallback to jsDelivr
            loadScript(
              'https://cdn.jsdelivr.net/npm/decap-cms@3.7.1/dist/decap-cms.js',
              arguments.callee.onSuccess,
              arguments.callee.onError
            );
          }
        );
      }

      // Start the process
      domReady(initCMS);
    })();
  </script>
</body>
</html>
